<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장바구니</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/cart/style.css}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
        // 전체 선택 기능을 위한 JavaScript 함수
        function toggleSelectAll(selectAllCheckbox) {
            var checkboxes = document.querySelectorAll('input[name="selectedProducts"]');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = selectAllCheckbox.checked;
            });
            calculateTotal();
        }

        // 수량 증감
        // function qtyModify(input) {
        //     var row = input.closest('tr');
        //     var price = row.querySelector('priceSpan').textContent;
        //     var quantity = row.querySelector('td.quantity-input').textContent;
        //
        //     var itemTotal = row.querySelector('.itemTotalPrice');
        //     itemTotal.textContent = parseInt(price) * parseInt(quantity);
        //
        //     console.log("row", row);
        //     console.log("price", price);
        //     console.log("quantity", quantity);
        //
        //     // AJAX 요청으로 수량 변경 사항을 서버에 전달
        //
        //     calculateTotal(); // 전체 합계 다시 계산
        // }

        // 선택된 상품의 가격 합계를 계산하는 함수
        function calculateTotal() {
            var total = 0;
            var checkboxes = document.querySelectorAll('input[name="selectedProducts"]:checked');
            console.log("checkboxs", checkboxes);

            checkboxes.forEach(function(checkbox) {
                var row = checkbox.closest('tr');
                var price = row.querySelector('td.itemTotalPrice').textContent;

                total += parseInt(price);

                console.log("row",row);
                console.log("price", price);
                console.log("typeof total : "+ typeof total);
                console.log("total : "+ total);
            });
            document.getElementById('totalPrice').textContent = total.toLocaleString();
        }
        function confirmDelete() {
            return confirm("선택한 상품을 삭제하시겠습니까?");
        }


        function increment() {
            var quantityInput = document.getElementById('quantity-input');
            var currentValue = parseInt(quantityInput.value);
            quantityInput.value = currentValue + 1;
        }

        function decrement() {
            var quantityInput = document.getElementById('quantity-input');
            var currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
        }

    </script>
</head>
<body>

<h1>Shopping Cart</h1>

<h2 th:text="${custId}+'회원의 장바구니 상품 목록'">[]회원의 장바구니 상품 목록</h2>

<script>
    let msg = "${msg}"
    if (msg == "DEL_OK") alert("성공적으로 삭제되었습니다.");
    if (msg == "DEL_ERR") alert("삭제에 실패했습니다.");
    //if(msg == "WRT_OK") alert("성공적으로 게시물이 등록되었습니다.");
</script>

<div th:if="${cartProdDto != null and !cartProdDto.isEmpty()}" class="container">

    <!-- 체크박스 전체 여부 -->
    <div class="all_check_input_div">
        <input type="checkbox" onclick="toggleSelectAll(this)" ><span class="all_chcek_span" >전체선택</span>
    </div>

    <table>
        <thead>
        <tr>
            <th></th>
            <th>Product Name</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="product : ${cartProdDto}">
            <td><input type="checkbox" name="selectedProducts" th:value="${product.prodId}" onclick="calculateTotal()" /></td>
            <td th:text="${product.prodName}">Product Name</td>
            <td th:id="priceSpan" th:text="${product.salePrice}">Price</td>
            <td th:id="qtySpan" class="quantity-wrapper">
                <button type="button" onclick="decrement()">&#8722;</button>
                <input type="text" th:value="${product.itemQty}" id="quantity-input" readonly />
                <button type="button" onclick="increment()">&#43;</button>
            </td>
            <td th:class="itemTotalPrice" th:text="${product.salePrice * product.itemQty}">Total Price</td>
            <td>
                <form action="/cart/remove" method="get" id="removeBtn" onsubmit="return confirmDelete()">
                    <input type="submit" value="삭제">
                    <input type="hidden" name="prodId" th:value="${product.prodId}">
                </form>
            </td>

        </tr>
        </tbody>
    </table>

    <!-- 오른쪽에 총 결제 금액과 주문하기 버튼을 포함하는 부분 -->
    <div class="order-summary">
        <strong>총 결제 금액: <span id="totalPrice">0</span>원</strong>
        <button onclick="order()">주문하기</button>
    </div>

</div>

<div th:if="${cartProdDto == null or cartProdDto.isEmpty()}">
    <p>장바구니에 담긴 상품이 없습니다.</p>
</div>

<script>

    function order() {
        var totalAmount = document.getElementById('totalPrice').textContent;
        alert('총 ' + totalAmount + ' 금액의 주문이 완료되었습니다.');
        // 여기에 실제 주문 처리를 위한 추가 로직을 구현할 수 있습니다.
        // 주문완료되면 장바구니에서 상품 삭제
    }
</script>

</body>
</html>
